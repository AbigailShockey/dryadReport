---
output:
  pdf_document:
    latex_engine: xelatex
header-includes:
    - \usepackage{fancyhdr}
    - \usepackage{fontspec}
    - \usepackage{xcolor}
    - \geometry{left=0.5in,right=0.5in}
mainfont: Roboto
sansfont: Roboto
urlcolor: badgerred
---
<!-- define color and adjust lengths for header and footer-->
\definecolor{badgerred}{RGB}{197,5,12}
\addtolength{\headheight}{3.0cm}
\addtolength{\topmargin}{-0.5in}
\addtolength{\footskip}{-0.225in}

<!-- % setup header -->
\pagestyle{fancy}
\fancyhf{}

<!-- header content -->
\fancyhead[L]{\raisebox{-0.25\height}{\includegraphics[height=2.5cm]{/assets/wslh_header.png}}}
\fancyhead[R]{\Huge Genomic Clustering Report\\
\Large `r paste(Sys.Date())`}

<!-- create red header line -->
\renewcommand{\headrulewidth}{1pt}
\renewcommand{\headrule}{\hbox to\headwidth{%
    \color{badgerred}\leaders\hrule height \headrulewidth\hfill}}

<!-- footer content -->
\fancyfoot[C]{For research use only, not for clinical use.}
\fancyfoot[R]{\thepage}

<!-- create red footer line -->
\renewcommand{\footrulewidth}{1pt}
\renewcommand{\footrule}{\hbox to\headwidth{%
    \color{badgerred}\leaders\hrule height \headrulewidth\hfill}}

```{r include=FALSE}
#testing
## Libraries
library(ggtree)
library(plyr)
library(tidyr)
library(phangorn)
library(reshape2)
library(ggplot2)
library(phytools)

date <- Sys.Date()

## Figure size
knitr::opts_chunk$set(out.width="7.5in", out.height="8in", fig.align="left")

```

### *`r species`* Analysis

The analysis of the *`r species`* samples (n = `r num.iso`) has been completed. These results must always be used in conjunction with epidemiological data when determining if isoaltes are epidemiologically linked. This analysis should not be used as a replacement for a thorough epidemiological investigation.

### SNP Heatmap and Core-Genome Tree

The number of Single Nucleotide Polymorphisms (SNPs) between each sample is shown on the heatmap below, with the core-genomy tree on the left. There is no hard and fast rule for determining how many SNPs are needed to classify an outbreak. Generally it is best to look for patterns in the data between the SNP data and the core-genome tree.

```{r echo=FALSE, message=FALSE, warning=FALSE}

# snp.mat <- read.table("", header = T, stringsAsFactors = F)
# nwk <- ""

### This section is optimized for round numbers of samples (5, 10, 15, 20, etc)
#### The variables that will most likely need to be changed are offset and rownames_offset

### Set seed for reproducibility
set.seed(123)

### Read tree and midpoint root
tree <-  read.tree(nwk)
mpt <- midpoint.root(tree)

### Replace "." with "-" column names
colnames(snp.mat) <- gsub("X","",colnames(snp.mat))
colnames(snp.mat) <- gsub("\\.","-",colnames(snp.mat))

### Split isolate IDs by delimiter "-" and "_" (for >= 20 isolates)
if (length(mpt$tip.label) >= 20) {
  delim <- "[-|_]"
  mpt$tip.label <- sapply(strsplit(mpt$tip.label, delim), "[[", 1)
  rownames(snp.mat) <- sapply(strsplit(rownames(snp.mat), delim), "[[", 1)
  colnames(snp.mat) <- sapply(strsplit(colnames(snp.mat), delim), "[[", 1)
}

### Plot midpoint-rooted tree
gtree <- ggtree(mpt, size =.25, branch.length = "none")

### Convert midpoint-rooted tree to dataframe, get vertical order of tip labels and order snp matrix by tip labels
mpt.fort <- fortify(mpt)
mpt.tip <- mpt.fort[which(mpt.fort$isTip == TRUE),]
mpt.ord <- mpt.tip$label[order(mpt.tip$y)]
snp.mat <- snp.mat[c(mpt.ord),c(mpt.ord)]

### Plot midpoint-rooted tree with snp heatmap
if (length(mpt$tip.label) < 6) {
  ymax <- max(gtree$data$y) + 1
  ymin <- min(gtree$data$y) - 5

  gheatmap(gtree, snp.mat, width = 15,
           cell_labels = TRUE,
           font.size = 2.5,
           cell_font_size = 2.5,
           offset = 15,
           colnames_angle = 90,
           rownames_angle = 0,
           colnames_offset = .25,
           rownames_offset = -14) +
    scale_fill_viridis_c(limits= c(1,(max(snp.mat)+1)),na.value = "white", name = "SNPs",guide = "colourbar") +
    ylim(ymin,ymax) +
    theme(plot.margin = unit(c(0,0,0,0), "mm"),
          legend.position="bottom",
          legend.margin=margin(0,0,0,0),
          legend.box="horizontal",
          legend.text = element_text(size = 6),
          legend.title = element_text(size = 8)) +
    guides(fill = guide_colourbar(title.position="top",
                                  title.hjust = 0.5, barheight = .5, barwidth = 7))
}

if (length(mpt$tip.label) > 5 & length(mpt$tip.label) < 11) {
  ymax <- max(gtree$data$y) + 1
  ymin <- min(gtree$data$y) - 6.5

  gheatmap(gtree, snp.mat, width = 25,
           cell_labels = TRUE,
           font.size = 2.25,
           cell_font_size = 2.25,
           offset = 35,
           colnames_angle = 90,
           rownames_angle = 0,
           colnames_offset = .25,
           rownames_offset = -34) +
    scale_fill_viridis_c(limits= c(1,(max(snp.mat)+1)),na.value = "white", name = "SNPs",guide = "colourbar") +
    ylim(ymin,ymax) +
    theme(plot.margin = unit(c(0,0,0,0), "mm"),
          legend.position="bottom",
          legend.margin=margin(0,0,0,0),
          legend.box="horizontal",
          legend.text = element_text(size = 6),
          legend.title = element_text(size = 8)) +
    guides(fill = guide_colourbar(title.position="top",
                                  title.hjust = 0.5, barheight = .5, barwidth = 7))
}

if (length(mpt$tip.label) > 10 & length(mpt$tip.label) < 16) {
  ymax <- max(gtree$data$y) + 1
  ymin <- min(gtree$data$y) - 10

  gheatmap(gtree, snp.mat, width = 25,
           cell_labels = TRUE,
           font.size = 2.25,
           cell_font_size = 2.25,
           offset = 45,
           colnames_angle = 90,
           rownames_angle = 0,
           colnames_offset = .25,
           rownames_offset = -44) +
    scale_fill_viridis_c(limits= c(1,(max(snp.mat)+1)),na.value = "white", name = "SNPs",guide = "colourbar") +
    ylim(ymin,ymax) +
    theme(plot.margin = unit(c(0,0,0,0), "mm"),
          legend.position="bottom",
          legend.margin=margin(0,0,0,0),
          legend.box="horizontal",
          legend.text = element_text(size = 6),
          legend.title = element_text(size = 8)) +
    guides(fill = guide_colourbar(title.position="top",
                                  title.hjust = 0.5, barheight = .5, barwidth = 7))
}

if (length(mpt$tip.label) > 15 & length(mpt$tip.label) < 21) {
  ymax <- max(gtree$data$y) + 1
  ymin <- min(gtree$data$y) - 4

  gheatmap(gtree, snp.mat, width = 40,
           cell_labels = TRUE,
           font.size = 2.25,
           cell_font_size = 2.25,
           offset = 28,
           colnames_angle = 90,
           rownames_angle = 0,
           colnames_offset = .25,
           rownames_offset = -27) +
    scale_fill_viridis_c(limits= c(1,(max(snp.mat)+1)),na.value = "white", name = "SNPs",guide = "colourbar") +
    ylim(ymin,ymax) +
    theme(plot.margin = unit(c(0,0,0,0), "mm"),
          legend.position="bottom",
          legend.margin=margin(0,0,0,0),
          legend.box="horizontal",
          legend.text = element_text(size = 5),
          legend.title = element_text(size = 7)) +
    guides(fill = guide_colourbar(title.position="top",
                                  title.hjust = 0.5, barheight = .5, barwidth = 6))
  }

if (length(mpt$tip.label) > 20 & length(mpt$tip.label) < 26) {
  ymax <- max(gtree$data$y) + 1
  ymin <- min(gtree$data$y) - 3

  gheatmap(gtree, snp.mat, width = 60,
           cell_labels = TRUE,
           font.size = 1.75,
           cell_font_size = 1.75,
           offset = 35,
           colnames_angle = 90,
           rownames_angle = 0,
           colnames_offset = .25,
           rownames_offset = -34) +
    scale_fill_viridis_c(limits= c(1,(max(snp.mat)+1)),na.value = "white", name = "SNPs",guide = "colourbar") +
    ylim(ymin,ymax) +
    theme(plot.margin = unit(c(0,0,0,0), "mm"),
          legend.position="bottom",
          legend.margin=margin(0,0,0,0),
          legend.box="horizontal",
          legend.text = element_text(size = 5),
          legend.title = element_text(size = 7)) +
    guides(fill = guide_colourbar(title.position="top",
                                  title.hjust = 0.5, barheight = .5, barwidth = 6))
}

if (length(mpt$tip.label) > 25 & length(mpt$tip.label) < 31) {
  ymax <- max(gtree$data$y) + 1
  ymin <- min(gtree$data$y) - 4

  gheatmap(gtree, snp.mat, width = 60,
           cell_labels = TRUE,
           font.size = 1.75,
           cell_font_size = 1.5,
           offset = 45,
           colnames_angle = 90,
           rownames_angle = 0,
           colnames_offset = .25,
           rownames_offset = -43) +
    scale_fill_viridis_c(limits= c(1,(max(snp.mat)+1)),na.value = "white", name = "SNPs",guide = "colourbar") +
    ylim(ymin,ymax) +
    theme(plot.margin = unit(c(0,0,0,0), "mm"),
          legend.position="bottom",
          legend.margin=margin(0,0,0,0),
          legend.box="horizontal",
          legend.text = element_text(size = 5),
          legend.title = element_text(size = 6)) +
    guides(fill = guide_colourbar(title.position="top",
                                  title.hjust = 0.5, barheight = .5, barwidth = 6))
}

if (length(mpt$tip.label) > 30 & length(mpt$tip.label) < 36) {
  ymax <- max(gtree$data$y) + 1
  ymin <- min(gtree$data$y) - 3

  gheatmap(gtree, snp.mat, width = 60,
       cell_labels = TRUE,
       font.size = 1.5,
       cell_font_size = 1.2,
       offset = 35,
       colnames_angle = 90,
       rownames_angle = 0,
       colnames_offset = .25,
       rownames_offset = -34) +
   scale_fill_viridis_c(limits= c(1,(max(snp.mat)+1)), na.value = "white", name = "SNPs",guide = "colourbar") +
   ylim(ymin,ymax) +
   theme(plot.margin = unit(c(0,0,0,0), "mm"),
      legend.position="bottom",
      legend.margin=margin(0,0,0,0),
      legend.box="horizontal",
      legend.text = element_text(size = 4),
      legend.title = element_text(size = 5)) +
   guides(fill = guide_colourbar(title.position="top",
                  title.hjust = 0.5, barheight = .5, barwidth = 5))
}

```
\newpage

### Core-genome phylogenetic tree

The core-genome is the core set of genes shared across all isolates in the sample. Using variation within that core set of genes, we can estimate how related isolates are. We do this by determining if isolates share a similar common ancestor. Here we are looking for isolates that cluster together and share a small amount of horizontal distance on the tree. Bootstrap values are shown on the tree. A bootstrap value greater than 95 suggests the placement of a branch on the tree is well supported.

```{r echo=FALSE, message=FALSE, warning=FALSE}

if (length(mpt$tip.label) < 11) {
  q <- ggtree(mpt, color = "black", alpha = .6) +
  geom_nodelab(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), vjust=-.5, nudge_x = -.0005, size = 1.75) +
  # geom_label2(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), size = 2, label.size = .1, nudge_x = -.0002) +
  geom_tiplab(size = 1.75) +
  geom_treescale(offset = .1, y = 0, x = 0, fontsize = 1.75) +
  theme(plot.margin = unit(c(0,0,0,0), "cm"))

  log10_ceiling <- function(x) {
    10^(ceiling(log10(x)))
  }
  xmax <- max(q$data$x) + (log10_ceiling(max(q$data$x))/10)
  xmin <- 0

  q + xlim(xmin,xmax) + ylim(0,max(q$data$y))
}

if (length(mpt$tip.label) > 10 & length(mpt$tip.label) < 21) {
  q <- ggtree(mpt, color = "black", alpha = .6) +
  geom_nodelab(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), vjust=-.5, nudge_x = -.0005, size = 1.75) +
  # geom_label2(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), size = 2, label.size = .1, nudge_x = -.0002) +
  geom_tiplab(size = 1.75) +
  geom_treescale(offset = .1, y = 0, x = 0, fontsize = 1.75) +
  theme(plot.margin = unit(c(0,0,0,0), "cm"))

  log10_ceiling <- function(x) {
    10^(ceiling(log10(x)))
  }
  xmax <- max(q$data$x) + (log10_ceiling(max(q$data$x))/10)
  xmin <- 0

  q + xlim(xmin,xmax) + ylim(0,max(q$data$y))
}

if (length(mpt$tip.label) > 20 & length(mpt$tip.label) < 31) {
  q <- ggtree(mpt, color = "black", alpha = .6) +
  geom_nodelab(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), vjust=-.5, nudge_x = -.0005, size = 1.75) +
  # geom_label2(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), size = 2, label.size = .1, nudge_x = -.0002) +
  geom_tiplab(size = 1.75) +
  geom_treescale(offset = .2, y = 0, x = 0, fontsize = 1.75) +
  theme(plot.margin = unit(c(0,0,0,0), "cm"))

  log10_ceiling <- function(x) {
    10^(ceiling(log10(x)))
  }
  xmax <- max(q$data$x) + (log10_ceiling(max(q$data$x))/10)
  xmin <- 0

  q + xlim(xmin,xmax) + ylim(0,max(q$data$y))
}

if (length(mpt$tip.label) > 30) {
  q <- ggtree(mpt, color = "black", alpha = .75) +
    geom_nodelab(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), vjust=-.5, size = 2) +
    # geom_label2(aes(label=label, x = branch, subset = !isTip & (as.numeric(label) > 95)), size = 2, label.size = .1, nudge_x = -.0002) +
    geom_tiplab(size = 2) +
    geom_treescale(offset = .5, y = 0, x = 0, fontsize = 2) +
    theme(plot.margin = unit(c(0,0,0,0), "cm"))

  log10_ceiling <- function(x) {
    10^(ceiling(log10(x)))
  }
  xmax <- max(q$data$x) + (log10_ceiling(max(q$data$x))/10)
  xmin <- 0

  q + xlim(xmin,xmax) + ylim(0,max(q$data$y))
}

```


### Methods

The figures shown here were generated using sequence data processed with our data analysis pipeline, Dryad ([https://github.com/k-florek/dryad](https://github.com/k-florek/dryad)). SNPs were called using the Center for Food Safety and Applied Nutrition ([CFSAN](https://github.com/CFSAN-Biostatistics/snp-pipeline)) SNP pipeline within Dryad. The core-genome tree was generated using an alignment of coding regions shared across 99% of isolates. The tree was generated using a maximum-likelihood method with the GTR+G substitution model and bootstrapped with 1000 replicates. Report generated using R and designed by Abigail Shockey. If you have questions about this report please contact Kelsey Florek at [kelsey.florek@slh.wisc.edu](kelsey.florek@slh.wisc.edu).
